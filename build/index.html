<html>
<head>
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.16/peer.min.js"></script> -->
	<!-- <script>
		// TypeScript 2.2 requires 'exports' global variable.
		var exports = {};
	</script> -->
	<script type="text/javascript" src="scripts/node.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
	<script src="scripts/springy.js"></script>
	<script src="scripts/springyui.js"></script>
	<script type="text/javascript">
		let networkNode = new Meshnetwork.Node();

		networkNode.onMessageReceived = function (src, data) {
			let log = document.getElementById("log");
			log.value = log.value + src + " sent " + data + "\n";
			log.scrollTop = log.scrollHeight;
		};

		networkNode.onConnectedToPeer = function(user) {
			let otherAddress = document.getElementById("otherAddress");
			otherAddress.innerText = user;
			console.log("A connection was made to peer", user);
		};
		networkNode.onDisconnectedFromNetwork = function() {
			document.getElementById("localAddress").innerText = "";
			document.getElementById("otherAddress").innerText = "";
			console.log("Disconnected from network.");
		};
		networkNode.onConnectedToNetwork = function(localNodeId) {
			let localAddress = document.getElementById("localAddress");
			localAddress.innerText = localNodeId;
			console.log("Connected to network with id:", localNodeId);
		};

		function onConnectButtonClicked() {
			let address = document.getElementById("peerIdTextInput").value;
			networkNode.connectToPeer(address);
		}
		function onSendButtonClicked() {
			let message = document.getElementById("messageInput").value;
			let sendToAddress = document.getElementById("sendToAddress").value;
			networkNode.sendData(message, sendToAddress);
		}

		function copyLocalAddress() {
			var copyText = document.getElementById("localAddress");
			var textArea = document.createElement("textarea");
			textArea.value = copyText.innerText;
			document.body.appendChild(textArea);
			textArea.select();
			document.execCommand("Copy");
			textArea.remove();
		}

		// Graph visualisation.
		networkNode.onNetworkChange = function() {
			let graph = new Springy.Graph();
			let nodes = new Map();

			for (let node of networkNode.networkTopography.keys()) {
				nodes.set(node, graph.newNode({ label: node }));
			}

			for (let edges of networkNode.networkTopography.entries()) {
				for (let node of edges[1].values()) {
					graph.newEdge(nodes.get(edges[0]), nodes.get(node));
				}
			}

			$('.network-graph').springy({ graph: graph });
		}
	</script>
	<style>
		.grid {
			display: grid;
			grid-gap: 1em;
			grid-template-columns: 1fr 2fr;
		}
		.interface {
			grid-column: 1 2;
		}
		.network-graph {
			grid-column: 2 3;
		}
	</style>
</head>
<body>
	<div class="grid">
		<div class="interface">
			<p>
				Local peer ID: <b id="localAddress"></b>
				<button onclick="copyLocalAddress()">Copy address</button>
			</p>
			<p>Connected to peer: <b id="otherAddress"></b></p>
			<p>
				Peer ID: <input type="text" id="peerIdTextInput">
				<input type="submit" value="Connect" onclick="onConnectButtonClicked()">
			</p>
			<p>
				Send to peer: <input type="text" id="sendToAddress">
			</p>
			<p>
				Message: <input type="text" id="messageInput">
				<input type="submit" value="Send" onclick="onSendButtonClicked()">
			</p>
			<p><textarea id="log" style="width: 500;height: 300;"></textarea></p>
		</div>
		<canvas class="network-graph" width="100%" height="100%">
	</div>
	<script type="text/javascript">
		var canvas = document.querySelector('.network-graph');
		fitToContainer(canvas);

		function fitToContainer(canvas) {
			// Make it visually fill the positioned parent
			canvas.style.width = '100%';
			canvas.style.height = '100%';
			// ...then set the internal size to match
			canvas.width = canvas.offsetWidth;
			canvas.height = canvas.offsetHeight;
		}
	</script>
</body>
</html>